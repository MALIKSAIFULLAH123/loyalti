"use strict";(self.webpackChunk_metafox_react=self.webpackChunk_metafox_react||[]).push([["livevideo"],{89953(e,t,a){a.d(t,{A:()=>S});var i=a(91557),o=a(3556),r=a(8051),n=a(87773),l=a(96540),d=a(20687),c=a(89335),s=a(50203),u=a(57660),v=a(84058),m=a.n(v);let f="LivestreamingDeviceOptions",g=(0,o.Ay)(r.A,{name:f,slot:"wrapper"})(({theme:e})=>({display:"flex",margin:e.spacing(-1),"& > *":{flex:1,minWidth:0,padding:e.spacing(1)}})),p=(0,o.Ay)(r.A,{name:f,slot:"root"})(({theme:e})=>({display:"block"})),b=({onDeviceChange:e,sx:t={},defaultValues:a={}})=>{let{i18n:o}=(0,i.PCX)(),[n,v]=(0,l.useState)({video:[],audio:[]}),[f,b]=(0,l.useState)((null==a?void 0:a.video)||""),[h,y]=(0,l.useState)((null==a?void 0:a.audio)||"");return(0,l.useEffect)(()=>{(async function(){let e=await navigator.mediaDevices.enumerateDevices();v({video:e.filter(e=>"videoinput"===e.kind),audio:e.filter(e=>"audioinput"===e.kind)})})()},[]),l.createElement(p,{sx:t},l.createElement(g,null,l.createElement(r.A,null,l.createElement(d.A,{fullWidth:!0},l.createElement(c.A,null,o.formatMessage({id:"camera"})),l.createElement(s.A,{"data-testid":m()("select_camera"),value:f,onChange(t){b(t.target.value),e(t.target.value,h)},label:o.formatMessage({id:"camera"})},n.video.map(e=>l.createElement(u.A,{key:e.deviceId,value:e.deviceId},e.label||`${o.formatMessage({id:"camera"})} ${n.video.indexOf(e)+1}`))))),l.createElement(r.A,null,l.createElement(d.A,{fullWidth:!0},l.createElement(c.A,null,o.formatMessage({id:"microphone"})),l.createElement(s.A,{"data-testid":m()("select_audio"),value:h,onChange(t){y(t.target.value),e(f,t.target.value)},label:o.formatMessage({id:"microphone"})},n.audio.map(e=>l.createElement(u.A,{key:e.deviceId,value:e.deviceId},e.label||`${o.formatMessage({id:"microphone"})} ${n.video.indexOf(e)+1}`)))))))};var h=a(40515),y=a(2404),E=a.n(y);let w="LivestreamWebcam",_=(0,o.Ay)(r.A,{name:w,slot:"root"})(({theme:e})=>({position:"relative",display:"block","& video":{width:"100%"}})),k=(0,o.Ay)(r.A,{name:w,slot:"placeholder"})(({theme:e})=>({position:"relative",backgroundColor:"#333",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center","& video":{position:"absolute",top:0,left:0,width:"100%",height:"100%"},"&:before":{content:'""',display:"block",paddingBottom:"56.25%"}})),A=()=>{let{i18n:e}=(0,i.PCX)();return l.createElement(k,null,l.createElement(n.A,{variant:"body1",sx:{display:"flex",alignItems:"center",flexDirection:"column",justifyContent:"center",fontSize:"24px"}},l.createElement(h.s4,{icon:"ico-videocam",sx:{fontSize:40,mb:2}}),l.createElement(r.A,{ml:1},e.formatMessage({id:"connect_devices_to_go_live"}))))},C=({onReady:e,streamKey:t,sxDeviceWrapper:a,deviceDefault:o,id:n})=>{let{dispatch:d,getSetting:c,livestreamingSocket:s,dialogBackend:u,i18n:v,setNavigationConfirm:m}=(0,i.PCX)(),f=l.useRef(null),g=l.useRef(null),p=l.useRef(void 0),{per_time_recorder_webcam:h=1e3}=c("livestreaming"),y=l.useRef(null),w=s.getStatus(),[C,S]=l.useState("initialized"===w),[x,M]=l.useState(!1),[I,R]=l.useState(o),D=l.useCallback(()=>{let e=navigator.connection,t=(null==e?void 0:e.effectiveType)||"4g",a={"4g":{video:25e5,audio:128e3,framerate:30},"3g":{video:1e6,audio:64e3,framerate:24},"2g":{video:5e5,audio:32e3,framerate:15}};return a[t]||a["4g"]},[]),T=l.useCallback(e=>{var t;let a=window.performance,i=(null===(t=a.memory)||void 0===t?void 0:t.usedJSHeapSize)>5e8;return{width:{ideal:i?854:1280},height:{ideal:i?480:720},frameRate:{ideal:e.framerate}}},[]),P=l.useCallback(()=>{for(let e of["video/webm; codecs=vp9,opus","video/webm; codecs=vp8,opus","video/mp4; codecs=h264,aac"])if(MediaRecorder.isTypeSupported(e))return e;for(let t of["video/webm; codecs=vp9","video/webm; codecs=vp8","video/webm","video/mp4"])if(MediaRecorder.isTypeSupported(t))return t;return"video/webm"},[]),z=l.useCallback(async()=>{if(!t||!s)return!0;let e=await s.waitDdpMethod({name:"streaming",id:"result/streaming",params:[t]});return!e.error||(u.alert({message:e.msg?v.formatMessage({id:e.msg}):void 0}),!1)},[t,s,u,v]),O=l.useCallback(e=>{let t=D(),a=P(),i=e.getAudioTracks().length>0,o=a.includes("opus")||a.includes("aac"),r=new MediaRecorder(e,{mimeType:a,videoBitsPerSecond:t.video,audioBitsPerSecond:i&&o?t.audio:0});return p.current&&s&&(r.ondataavailable=async e=>{e.data.size>0&&s&&s.sendRaw(e.data)}),r},[D,P,s]),j=l.useCallback(()=>{if(!y.current||!g.current)return;g.current.stop();let e=O(y.current);g.current=e,e.start(h)},[O,h]);l.useEffect(()=>{let e=navigator.connection;if(e)return e.addEventListener("change",j),()=>e.removeEventListener("change",j)},[j]);let L=async()=>{y.current&&y.current.getTracks().forEach(e=>e.stop());let a=null==I?void 0:I.video,i=null==I?void 0:I.audio;try{if(t){p.current=t;let o=await z();if(!o)return}let r=D(),n=T(r),l=await navigator.mediaDevices.getUserMedia({video:{deviceId:a?{exact:a}:void 0,...n},audio:{deviceId:i?{exact:i}:void 0,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});M(!0);let d=l.getVideoTracks()[0],c=l.getAudioTracks()[0],s={video:null==d?void 0:d.getSettings().deviceId,audio:null==c?void 0:c.getSettings().deviceId};E()(s,I)||R(s),f.current&&(f.current.srcObject=l),y.current=l,e&&e(s);let u=O(l);g.current=u,u.start(h)}catch(b){console.error("Error starting stream webcam:",b);try{let v=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:15}},audio:{deviceId:i?{exact:i}:void 0,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});f.current&&(f.current.srcObject=v),y.current=v}catch(m){console.error("Fallback stream failed:",m)}}},W=(e,t)=>{R({video:e,audio:t})};return l.useEffect(()=>(d({type:"livestreaming/socket/init",meta:{onSuccess(){S(!0)}}}),t&&(m(!0,{message:v.formatMessage({id:"live_video_is_on_going_are_you_sure_to_leave_now"})},()=>{d({type:"livestreaming/end-live/force",payload:{id:n}})}),window.onbeforeunload=()=>v.formatMessage({id:"live_video_is_on_going_are_you_sure_to_leave_now"})),()=>{y.current&&y.current.getTracks().forEach(e=>e.stop()),t&&(s.close(),window.onbeforeunload=void 0,m(!1))}),[]),l.useEffect(()=>{C&&L()},[C,null==I?void 0:I.video,null==I?void 0:I.audio]),l.createElement(_,null,l.createElement(r.A,null,x?null:l.createElement(A,null),l.createElement(k,{sx:{display:x?"block":"none"}},l.createElement("video",{ref:f,autoPlay:!0,playsInline:!0,controls:!1,muted:!0})),I?l.createElement(b,{defaultValues:I,sx:a,onDeviceChange:W}):null))},S=C},88073(e,t,a){a.r(t),a.d(t,{default:()=>o});var i=a(89953);let o=i.A}}]);