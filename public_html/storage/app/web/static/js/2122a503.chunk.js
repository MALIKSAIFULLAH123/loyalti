"use strict";(self.webpackChunk_metafox_react=self.webpackChunk_metafox_react||[]).push([["composer"],{51689(e,t,n){n.r(t),n.d(t,{default:()=>J});var l=n(91557),a=n(67725),r=n(96540);let i={editorControls:[{as:"lexical.control.attachEmoji"},{as:"commentComposer.control.attachFile",showWhen:["and",["falsy","editing"],["falsy","previewFiles"],["truthy","acl.chat.chat_message.send_attachment"]]},{as:"chatComposer.control.buttonSubmit"}]};var o=n(8022),s=n(40515),c=n(3556),u=n(63461),d=n(97763);let m=(0,c.Ay)(u.A)(({theme:e})=>({padding:0,display:"inline-flex",alignItems:"center",justifyContent:"center",width:e.spacing(3.5),height:e.spacing(3.5),minWidth:e.spacing(3.5),color:e.palette.text.secondary})),p=(0,c.Ay)(s.s4)(({theme:e})=>({fontSize:e.spacing(1.75)})),f=r.forwardRef(function({title:e,icon:t,onClick:n,testid:l},a){return r.createElement(d.A,{title:e},r.createElement(m,{onClick:n,size:"small",ref:a,"data-testid":l,role:"button"},r.createElement(p,{icon:t})))});var h=n(84535),g=n(2109),v=n(7256),_=n(42421),C=n.n(_),y=n(96435),E=n(48946),x=n(5744),b=n(8051),A=n(39120);function w(){return(w=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var l in n)Object.prototype.hasOwnProperty.call(n,l)&&(e[l]=n[l])}return e}).apply(this,arguments)}let R={ltr:"ltr",rtl:"rtl",placeholder:"editor-placeholder",paragraph:"editor-paragraph",hashtag:"editor-hashtag"},M="EditorComment",I=(0,c.Ay)(b.A,{name:M,slot:"PlaceHolder"})(({theme:e})=>({position:"absolute",color:e.palette.text.hint,overflow:"hidden",top:0,left:0,bottom:0,display:"flex",alignItems:"center",userSelect:"none",pointerEvents:"none"})),S=(0,c.Ay)(b.A,{name:M,slot:"EditorContainer"})(({theme:e})=>({position:"relative",width:"100%",border:"light"===e.palette.mode?e.mixins.border("secondary"):"solid 1px rgba(73, 73, 73, 0.2)",backgroundColor:e.palette.action.hover,minHeight:e.spacing(4),borderRadius:e.spacing(3),display:"flex",flexFlow:"wrap",transition:"all 200ms ease 0s",overflow:"hidden",[e.breakpoints.down("md")]:{minHeight:e.spacing(5)},"& .editor-input":{width:"100%",outline:"none","& p":{margin:0,padding:0},"& .editor-hashtag, & .editor-mention":{color:e.palette.primary.main}},padding:"0 !important"})),O=(0,c.Ay)(b.A,{name:M,slot:"EditorCompose"})(({theme:e})=>({position:"relative",width:"100%",display:"flex",alignItems:"center"}));function k(e){let{editorRef:t}=e,n={theme:R,onError(e){throw e},editorState(n){(0,A.le)(n,(null==e?void 0:e.value)||""),t.current.editor=n},...(null==e?void 0:e.initEditorConfig)||{}};return r.createElement(h.LexicalComposer,{initialConfig:n},r.createElement(P,w({},e)))}function P(e){let{onChange:t,value:n,plugins:l,placeholder:a,sx:i,onFocus:o,onBlur:s}=e,[c,u]=r.useState(!1),d=(0,A.pt)(),m=r.useRef(!1),[p]=(0,x.useLexicalComposerContext)(),f=r.useRef();r.useEffect(()=>{setImmediate(()=>{m.current=!0})},[]);let h=e=>{t(e)},_=r.useCallback((e,t)=>{e.read(()=>{let e=(0,E.$generateHtmlFromNodes)(t,null),n=!(0,A.Un)(t.isComposing(),!0);h(n?e:""),u(n)})},[u,h]);r.useEffect(()=>{d?o&&o():s&&s()},[d]),r.useEffect(()=>{m.current&&p.update(()=>{if(d)return;let e=(0,E.$generateHtmlFromNodes)(p,null);e!==n&&(0,A.le)(p,n)})},[n]);let b=()=>{p.focus()};return r.createElement(S,{ref:f,sx:i,onClick:b},r.createElement(O,null,r.createElement(g.PlainTextPlugin,{contentEditable:r.createElement(v.ContentEditable,{className:"editor-input",spellCheck:!1}),placeholder:r.createElement(F,{placeholder:a}),ErrorBoundary:C()}),r.createElement(y.OnChangePlugin,{onChange:_}),l.map((e,t)=>r.createElement(e,{key:`plugin${t}`,refContainer:f}))))}function F({placeholder:e}){return r.createElement(I,null,e)}var T=n(53579);function N(){return(N=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var l in n)Object.prototype.hasOwnProperty.call(n,l)&&(e[l]=n[l])}return e}).apply(this,arguments)}function z({handlePastedFiles:e}){let[t]=(0,x.useLexicalComposerContext)();return r.useLayoutEffect(()=>t.registerCommand(T.PASTE_COMMAND,t=>{var n;let l=null===(n=t.clipboardData)||void 0===n?void 0:n.files;return(null==l?void 0:l.length)>0&&(e(l),!0)},T.COMMAND_PRIORITY_CRITICAL),[t,e]),null}function H({handleSubmit:e,isMobile:t}){let[n]=(0,x.useLexicalComposerContext)();return r.useLayoutEffect(()=>n.registerCommand(T.KEY_ENTER_COMMAND,l=>!t&&!!e&&(null!==l&&(l.preventDefault(),l.shiftKey)?n.dispatchCommand(T.INSERT_PARAGRAPH_COMMAND,void 0):(e(),!0)),T.COMMAND_PRIORITY_CRITICAL),[n,e,t]),null}function L({handleCancel:e}){let[t]=(0,x.useLexicalComposerContext)();return r.useLayoutEffect(()=>t.registerCommand(T.KEY_ESCAPE_COMMAND,t=>!!e&&(null!==t&&t.preventDefault(),e(),!0),T.COMMAND_PRIORITY_CRITICAL),[t,e]),null}function D(e){let{editorPlugins:t}=e;return r.createElement(k,N({},e,{plugins:[()=>r.createElement(H,{key:"enter-submit",handleSubmit:e.handleSubmit,isMobile:e.isMobile}),()=>r.createElement(L,{key:"esc",handleCancel:e.handleCancel}),()=>r.createElement(z,{key:"pasted-event",handlePastedFiles:e.handlePastedFiles}),...t]}))}let j=(0,c.Ay)("form",{name:"ComposerWrapper",slot:"RootStyled"})(({theme:e})=>({maxHeight:"200px",overflowY:"auto",flex:1,flexBasis:"auto",minWidth:0,display:"flex"}));function W({children:e,onClick:t}){return r.createElement(j,{onClick:t,"data-testid":"editor"},e)}let Y="ChatComposerForm",$=(0,c.Ay)("form",{name:Y,slot:"RootStyled"})(({theme:e})=>({width:"100%"})),B=(0,c.Ay)("div",{name:Y,slot:"composeOuter",shouldForwardProp:e=>"margin"!==e})(({theme:e,margin:t})=>({display:"flex",padding:e.spacing(.5,.5,.5,2),minHeight:e.spacing(4.25),alignItems:"center",overflowY:"auto",height:"100%",..."dense"===t&&{padding:e.spacing(.5)}})),K=(0,c.Ay)("div",{name:Y,slot:"composeInner"})(({theme:e})=>({flex:1,minWidth:0})),U=(0,c.Ay)("div",{name:Y,slot:"composeInputWrapper"})(({theme:e})=>({width:"100%",flexFlow:"wrap",display:"flex",alignItems:"center"}));function G({children:e,className:t,margin:n="normal"}){return r.createElement($,{className:t,role:"presentation","data-testid":"chatComposerForm"},r.createElement(B,{margin:n},r.createElement(K,null,r.createElement(U,null,e))))}let X=(0,c.Ay)("form",{name:"AttachIconsWrapper",slot:"RootStyled"})(({theme:e})=>({display:"inline-flex",alignItems:"flex-end",padding:"0 2px",marginLeft:"auto","& .ico-smile-o":{fontSize:e.mixins.pxToRem(15)}}));function q({children:e}){return r.createElement(X,null,e)}let J=r.forwardRef(function({rid:e,msgId:t,text:n="",focus:s=!0,reactMode:c,onSuccess:u,onMarkAsRead:d,margin:m="normal",previewRef:p},h){let{i18n:g,dispatch:v,jsxBackend:_,getAcl:C}=(0,l.PCX)(),y=C(),E=r.useRef(!0),x=r.useRef({}),[,,b]=(0,o.A)(),[A,w]=r.useState(n?(0,a.G9)(n):""),[R,M]=r.useState(!1),[I,S]=r.useState([]),O=r.useMemo(()=>({editing:"edit"===c,previewFiles:I.length,acl:y}),[c,I,y]),[k,,P]=(0,l.w5n)(i,O),F=g.formatMessage({id:"write_a_message"});(0,r.useEffect)(()=>{if(E.current){E.current=!1,n&&v({type:"chat/room/text",payload:{rid:e,text:""}});return}N(!1)},[e]),r.useEffect(()=>{"edit"===c&&(w(n),H()),"reply"===c&&H(),"no_react"===c&&w("")},[n,c,e,t]);let N=(e=!0)=>{var t,n,l,a,r;e&&(null===(a=x.current)||void 0===a||null===(r=a.editor)||void 0===r||r.blur()),w(""),(null===(t=p.current)||void 0===t?void 0:t.clear)&&(p.current.clear(),S([])),null===(n=x.current)||void 0===n||null===(l=n.editor)||void 0===l||l.update(()=>{let e=(0,T.$getRoot)();e.clear()})},z=r.useMemo(()=>({onSuccess(){N(),M(!1),"function"==typeof u&&u()}}),[N]),H=r.useCallback(()=>{setImmediate(()=>{var e,t;return null===(e=x.current)||void 0===e?void 0:null===(t=e.editor)||void 0===t?void 0:t.focus()})},[e]),L=()=>{var e;null===(e=p.current)||void 0===e||e.clear(),S([]),N(),M(!1),"no_react"!==c&&u()},j=()=>{M(!1)},Y=()=>(function(e){let t=document.createElement("textarea");return t.innerHTML=e,t.value})(A.replaceAll("<br>","\n").replace(/&nbsp;/gm," ").replace("&amp;","&").replace(/(<([^>]+)>)/gi,"")).trim(),$=()=>{let n=Y();n&&!R&&(M(!0),v({type:"chat/composer/SUBMIT",payload:{reactMode:c,rid:e,msgId:t,text:n},meta:z}))},B=()=>{if(I&&I.length&&Object.values(I).length){let n=Y();R||(M(!0),v({type:"chat/composer/upload",payload:{files:Object.values(I),rid:e,text:n,reactMode:c,msgId:t},meta:{onSuccess:L,onFailure:j}}))}else $()};r.useEffect(()=>{s&&H()},[s,H]),r.useImperativeHandle(h,()=>({attachFiles(e){(null==e?void 0:e.length)&&S(e)},removeFile(e){let t=[...I];e>-1&&(t.splice(e,1),S([...t]))}}));let K=r.useMemo(()=>{let e=Y();return!!(!R&&(null==I?void 0:I.length)||e)},[I,A,R]),U=e=>{var t,n,l;if((null==y?void 0:null===(t=y.chat)||void 0===t?void 0:null===(n=t.chat_message)||void 0===n?void 0:n.send_attachment)&&e.length&&p&&p.current){let a=b([...I,...e],!0);if(!a)return;S([...I,...e]),null===(l=p.current)||void 0===l||l.attachFiles(e)}},X=e=>{w(e)},J=()=>{H(),d()};return r.createElement(G,{margin:m},r.createElement(W,{onClick:J},r.createElement(D,{handleSubmit:B,onChange:X,value:A,editorRef:x,placeholder:F,handlePastedFiles:U,sx:{border:0,padding:"6px 12px",background:"none",overflow:"visible",minHeight:"32px"},editorPlugins:k})),r.createElement(q,null,P.map(t=>_.render({component:t.as,props:{key:t.as,previewRef:p,filesUploadRef:h,control:f,editorRef:x,rid:e,disableSubmit:K,handleSubmit:B}}))))})},8022(e,t,n){n.d(t,{A:()=>s});var l=n(91557),a=n(96540),r=n(62193),i=n.n(r),o=n(67725);function s(e){let{initialValues:t,messageAcceptFail:n,inputRef:r}=e||{},{dialogBackend:s,i18n:c,getSetting:u}=(0,l.PCX)(),[d,m]=a.useState(t||[]),p=a.useRef(!1),f=u("core.attachment.maximum_file_size_each_attachment_can_be_uploaded"),h=u("core.attachment.maximum_number_of_attachments_that_can_be_uploaded"),g=()=>{(null==r?void 0:r.current)&&(r.current.value=null)},v=(e,t=!1)=>{if(i()(e))return;let l=[],a=[],r=(t?0:d.length)+(null==e?void 0:e.length);if(h<r){s.alert({title:"Oops!",message:c.formatMessage({id:"could_not_select_more_than_limit_files"},{limit:h})});return}for(let u=0;u<e.length;++u){let v=e[u],_=v.size,C={file_name:v.name,file_size:v.size,file_type:v.type,file:v};if(!(0,o.HH)(null==v?void 0:v.type,"image/*")){s.alert({message:n||c.formatMessage({id:"file_accept_type_fail"})}).then(()=>p.current=!1).catch(()=>p.current=!1),p.current=!0,g();break}_>f&&0!==f?(C.max_size=f,a.push(C)):l.push(C.file)}if(!p.current){if(l.length&&m([...d||[],...l]),a.length>0){var y;s.alert({message:1===a.length?c.formatMessage({id:"warning_upload_limit_one_file"},{fileName:(0,o.Tu)(a[0].file_name,30),fileSize:(0,o.lT)(a[0].file_size),maxSize:(0,o.lT)(null===(y=a[0])||void 0===y?void 0:y.max_size)}):c.formatMessage({id:"warning_upload_limit_multi_image"},{numberFile:a.length,photoMaxSize:(0,o.lT)(f)})}),g();return}return g(),!0}};return[d,m,v]}}}]);