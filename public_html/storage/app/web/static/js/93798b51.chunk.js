(self.webpackChunk_metafox_react=self.webpackChunk_metafox_react||[]).push([["metafox-story-blocks-MainViewForm-Block"],{24713(e,t,i){var n=i(2523),o=i(15389),l=i(61489),a=Math.max;e.exports=function(e,t,i){var r=null==e?0:e.length;if(!r)return -1;var d=null==i?0:l(i);return d<0&&(d=a(r+d,0)),n(e,o(t,3),d)}},52240(e,t,i){"use strict";i.r(t),i.d(t,{default:()=>_});var n=i(91557),o=i(44562),l=i(85332),a=i(67725),r=i(3556),d=i(8051),s=i(96540),u=i(771),v=i(81925),c=i(84058),p=i.n(c);let y="Buttonitem",f=(0,r.Ay)(d.A,{name:y,shouldForwardProp:e=>"isMobile"!==e})(({theme:e,isMobile:t})=>({...t&&{width:"100%",marginBottom:e.spacing(2)}})),g=(0,r.Ay)(d.A,{name:y,shouldForwardProp:e=>"isMobile"!==e&&"name"!==e})(({theme:e,isMobile:t,name:i})=>({width:"220px",height:"330px",display:"flex",justifyContent:"center",alignItems:"center",borderRadius:e.shape.borderRadius,margin:e.spacing(0,1),padding:e.spacing(2),overflow:"hidden",wordBreak:"break-word",cursor:"pointer",fontSize:e.mixins.pxToRem(16),color:"#fff",...t&&{width:"100%",height:"150px",padding:0,margin:0},..."photo_story"===i&&{backgroundImage:`linear-gradient(0deg, ${(0,u.X4)(e.palette.primary.light,.5)} 0%, ${(0,u.X4)(e.palette.primary.main,.7)} 50%,  ${e.palette.primary.dark} 100%)`},..."text_story"===i&&{backgroundImage:`linear-gradient(0deg, ${(0,u.X4)(e.palette.error.light,.5)} 0%, ${(0,u.X4)(e.palette.error.main,.7)} 50%, ${e.palette.error.dark} 100%)`}})),m=function({item:e}){let{dialogBackend:t,i18n:i,useIsMobile:r,getSetting:d,useCheckFileUpload:u}=(0,n.PCX)(),c=d("core.file_mime_type_accepts.image")||["image/*"],y=c.join(),m=d("core.file_mime_type_accepts.video")||["video/*"],h=m.join(),_=d("story.video_duration")||o.oI,b=d("story.video_service_is_ready"),w=s.useMemo(()=>(null==e?void 0:e.accept)?null==e?void 0:e.accept:b?`${y},${h}`:y,[null==e?void 0:e.accept,b,y,h]),[S]=u({accept:w}),A=r(),k=s.useRef(),x=(0,l.Ay)(),C=s.useCallback(()=>{if(e){if((null==e?void 0:e.name)==="photo_story"){k.current.click();return}(null==x?void 0:x.setStatus)&&x.setStatus(null==e?void 0:e.name)}},[e]),R=async(t,i)=>{try{if((0,a.EL)(null==t?void 0:t.type)){let n=document.createElement("video");n.preload="metadata",n.onloadedmetadata=async()=>{window.URL.revokeObjectURL(n.src);let e=n.duration;i(e,t)},n.src=URL.createObjectURL(t);return}if((0,a.RX)((0,a.ti)(t))){let o=await (0,v.TA)(t);(0,v.md)(o,n=>{n?(x.setUploading(!0),x.setFilePhoto(t),x.setStatus(null==e?void 0:e.name)):i(void 0,t)});return}}catch(l){console.log(l)}},L=s.useCallback((n,o)=>{if(w.includes("video/*")&&(0,a.EL)(null==o?void 0:o.type)&&n>_){t.alert({message:i.formatMessage({id:"you_can_not_upload_videos_longer_than"},{value:_})});return}if(!(0,a.HH)(null==o?void 0:o.type,w)){t.alert({message:i.formatMessage({id:"file_accept_type_fail"})});return}o&&(x.setFilePhoto(o),x.setStatus(null==e?void 0:e.name))},[w,_,null==e?void 0:e.name]),O=()=>{let e=k.current.files,t=S(e);if(null==t?void 0:t.length){let i=t[0];R(i,L)}};if(!e)return null;let{label:P,name:I}=e||{};return s.createElement(f,{isMobile:A},s.createElement(g,{"data-testid":p()(`Button Item Menu ${I}`),onClick:C,isMobile:A,name:I},P),s.createElement("input",{required:!0,ref:k,type:"file",accept:w,multiple:!1,onChange:O,className:"srOnly"}))},h=(0,r.Ay)(d.A,{name:"MainViewForm",shouldForwardProp:e=>"isMobile"!==e})(({theme:e,isMobile:t})=>({width:"100%",height:"100%",display:"flex",justifyContent:"center",alignItems:"center",[e.breakpoints.down("sm")]:{flexDirection:"column"}})),_=(0,n.WvA)({extendBlock:function(){let{useAppMenu:e,useIsMobile:t,useSession:i,getAcl:r,getSetting:d,jsxBackend:u}=(0,n.PCX)(),v=t(!0),c=i(),p=r(),y=d(),f=u.get("story.block.storyReviewPhoto"),g=u.get("story.block.storyReviewBackground"),_=u.get("story.block.storyReviewPhotoMobile"),b=u.get("story.block.storyReviewBackgroundMobile"),w=(0,l.Ay)(),S=e(o.ap,"addStoryMenu"),A=(0,a.Ue)(S.items,{session:c,acl:p,setting:y,isMobile:v});if(A)return w.status===o.ip?v?s.createElement(_,null):s.createElement(f,null):w.status===o.xq?v?s.createElement(b,null):s.createElement(g,null):s.createElement(h,{isMobile:v},A.map(e=>s.createElement(m,{key:null==e?void 0:e.name,item:e})))},defaults:{blockLayout:"sidebar home story"}})},32113(e,t,i){"use strict";i.d(t,{vZ:()=>a,MO:()=>d,x6:()=>s});var n=i(91262),o=i(96540);let l=o.createContext({status:null,setStatus(){},setFilePhoto(){},filePhoto:null,setUploading(){},uploading:!1,setIsDirty(){},isDirty:!1,isSubmitting:!1,setIsSubmitting(){}}),a=l,r=o.createContext({}),d=r,s={identityStoryActive:void 0,identityUserStoryActive:void 0,listUserStories:[],pauseStatus:n.ZR.No,reactions:[],indexStoryActive:void 0,openStoryDetail:!1,openViewComment:!1,openActionItem:!1,readyStateFile:!1,progressVideoPlay:0,isLastStory:!1,isReady:!1,mutedStatus:!0,buffer:!1}},79655(e,t,i){"use strict";i.d(t,{A:()=>p,n:()=>v});var n=i(91557),o=i(24713),l=i.n(o),a=i(58156),r=i.n(a),d=i(44562),s=i(95093),u=i.n(s);let v=(e,t,i=3)=>t<i?"prev":t>e-i-1?"next":"",c=(e,t)=>{let{identity:i}=t,n=r()(e,i),o=new URL(window.location.href),a=new URLSearchParams(o.search).get("date");if(!n)return{};let s=u()(a).format("L"),c=`${d.Lp}/${s}`,p=r()(e,`pagination.${c}.ids`),y=r()(e,`pagination.${c}.pagesOffset.total`),f=r()(e,`pagination.${c}.ended`),g=r()(e,`pagination.${c}.pagesOffset.next_date`),m=r()(e,`pagination.${c}.pagesOffset.prev_date`),h=f?1:r()(e,`pagination.${c}.pagesOffset.current_page`),_=r()(e,`pagination.${c}.pagesOffset.per_page`),b=(null==n?void 0:n.user)?r()(e,n.user):void 0,w=null==p?void 0:p.length,S=1<w?l()(p,e=>e===i):-1,A=-1!==S?S:0,k=f?A:r()(e,`pagination.${c}.pagesOffset.pos`)||0,x={item:n,stories:p,user:b,total:y,nextDate:g,prevDate:m,pagingId:c,date:a,indexStoryActive:A,positionStory:_*(h-1)+k,shouldPreload:v(w,k+1)};return x},p=(0,n.NgA)(c)},85332(e,t,i){"use strict";i.d(t,{Ay:()=>v,F_:()=>f,P3:()=>p,Tq:()=>g,Uf:()=>y,aN:()=>_,vC:()=>c});var n=i(96540),o=i(32113),l=i(91557),a=i(44562),r=i(71468),d=i(69634),s=i(79655),u=i(1081);function v(){return n.useContext(o.vZ)}function c(){return n.useContext(o.MO)}function p(){var e,t;let{navigate:i,useGetItem:o}=(0,l.PCX)(),{listUserStories:a,identityUserStoryActive:r,identityStoryActive:d,fire:s}=c(),u=o(r),v=o(d),p=(0,l.UfA)(null==u?void 0:u.stories),y=null==p?void 0:p.findIndex(e=>(null==e?void 0:e.id)===(null==v?void 0:v.id)),f=null==a?void 0:a.findIndex(e=>(null==e?void 0:e.id)===(null==u?void 0:u.id)),g=(null==p?void 0:null===(e=p[0])||void 0===e?void 0:e.id)===(null==v?void 0:v.id),m=(null==u?void 0:u.stories.length)-1===y,h=(null==a?void 0:null===(t=a[0])||void 0===t?void 0:t.id)===(null==u?void 0:u.id)&&g,_=(null==a?void 0:a.length)-1===f&&m,b=!h,w=!_,S=n.useCallback(()=>{var e,t;if(b&&-1!==y){if(g){s({type:"setIdentityUserS_Active",payload:null===(t=a[f-1])||void 0===t?void 0:t._identity});return}s({type:"setIdentityStoryActive",payload:null==p?void 0:null===(e=p[y-1])||void 0===e?void 0:e._identity})}},[b,y,g,a,p,f]),A=n.useCallback(()=>{var e,t;if(_){i("/");return}if(w&&-1!==y){if(m){s({type:"setIdentityUserS_Active",payload:null===(t=a[f+1])||void 0===t?void 0:t._identity});return}s({type:"setIdentityStoryActive",payload:null==p?void 0:null===(e=p[y+1])||void 0===e?void 0:e._identity})}},[_,w,y,m,a,f,p]);return{hasPrev:b,hasNext:w,handlePrev:S,handleNext:A}}function y(e){let[t,i]=n.useState(0),[o,l]=n.useState(0),r=n.useRef(),d=n.useCallback(()=>{var n;if(!(null==e?void 0:e.current))return[t,o];let r=null==e?void 0:null===(n=e.current)||void 0===n?void 0:n.getBoundingClientRect(),d=(null==r?void 0:r.height)/a.us,s=null==r?void 0:r.height;window.screen.width<=d&&(s=(d=window.screen.width)*a.us),l(s),i(d)},[null==e?void 0:e.current]);return n.useEffect(()=>{var t;let i=e.current;if(i)return r.current=new ResizeObserver(()=>{d()}),d(),null===(t=r.current)||void 0===t||t.observe(i),()=>{null==r||r.current.disconnect()}},[d,null==e?void 0:e.current]),[t,o,d]}function f(){return(0,r.d4)(e=>(0,d.s)(e))}function g(){var e,t;let i=c(),{fire:o,stories:a,indexStoryActive:d,nextDate:u,prevDate:v,identityStoryActive:p,loading:y,total:f,positionStory:g,pagingId:m}=i,h=(0,r.d4)(e=>(0,l.qRQ)(e,m))||{},{prev_page:_,last_page:b,current_page:w}=(null==h?void 0:h.pagesOffset)||{},{useGetItem:S,useGetItems:A,dispatch:k,usePageParams:x}=(0,l.PCX)(),C=x(),R=S(p),L=A(a),O=(null==L?void 0:null===(e=L[0])||void 0===e?void 0:e.id)===(null==R?void 0:R.id)&&0===_,P=(null==a?void 0:a[(null==a?void 0:a.length)-1])===p&&b===w,I=!(!v&&O),M=!(!u&&P),$=(null==a?void 0:a[(null==a?void 0:a.length)-1])===p&&b!==w,E=(null==L?void 0:null===(t=L[0])||void 0===t?void 0:t.id)===(null==R?void 0:R.id)&&0!==_,U=(e,t=()=>{})=>{var n;let l=e=>{var t;let i=null==e?void 0:e.pagingId,n=null==e?void 0:e.ids;if(!i||!(null==n?void 0:n.length))return;let l=null==e?void 0:null===(t=e.pagesOffset)||void 0===t?void 0:t.total;o({type:"setInit",payload:{stories:n,total:l,loading:!1}})},a=(0,s.n)(null==i?void 0:null===(n=i.stories)||void 0===n?void 0:n.length,e);if(!a){t&&t();return}t&&t(),k({type:"story/story_archive/LOAD",payload:{user_id:null==C?void 0:C.user_id,date:null==i?void 0:i.date,direction:a},meta:{onSuccess:l}})},F=(e,t)=>{var i,n,l;let a=null==e?void 0:e.pagingId,r=null==e?void 0:e.ids;if(!a||!(null==r?void 0:r.length))return;let d=null==e?void 0:null===(i=e.pagesOffset)||void 0===i?void 0:i.total,s=null==e?void 0:null===(n=e.pagesOffset)||void 0===n?void 0:n.next_date,u=null==e?void 0:null===(l=e.pagesOffset)||void 0===l?void 0:l.prev_date;o({type:"setLoading",payload:!1}),o({type:"setInit",payload:{isReady:!1,stories:r,total:d,nextDate:s,prevDate:u,indexStoryActive:0,positionStory:0,identityStoryActive:null==r?void 0:r[0],pagingId:a,date:t}})},B=()=>{o({type:"setLoading",payload:!1})},X=n.useCallback(()=>{if(E&&o({type:"setLoading",payload:!0}),!y&&I&&!E){if(O){o({type:"setLoading",payload:!0}),k({type:"story/story_archive/LOAD",payload:{user_id:null==C?void 0:C.user_id,date:v},meta:{onSuccess:e=>F(e,v),onError:B}});return}U(d-1),o({type:"setStoryActive",payload:{identity:null==a?void 0:a[d-1],index:d-1,positionStory:g-1}})}},[I,a,d,O,y,E,U,g,L,v]),D=n.useCallback(()=>{if($&&o({type:"setLoading",payload:!0}),!y&&M&&!$){if(P){o({type:"setLoading",payload:!0}),k({type:"story/story_archive/LOAD",payload:{user_id:null==C?void 0:C.user_id,date:u},meta:{onSuccess:e=>F(e,u),onError:B}});return}U(d+1),o({type:"setStoryActive",payload:{identity:null==a?void 0:a[d+1],index:d+1,positionStory:g+1}})}},[M,a,d,P,f,$,y,U,u,g,L]);return{hasPrev:I,hasNext:M,handlePrev:X,handleNext:D,loadmore:U}}let m=e=>(e.preaction.data.reactions||[]).filter(e=>e.is_active),h=(0,u.Mz)(m,e=>e);function _(){return(0,r.d4)(h)}},91262(e,t,i){"use strict";var n,o,l,a,r,d,s,u;i.d(t,{ZR:()=>n,Zw:()=>o,dw:()=>a,gw:()=>l}),(r=n||(n={}))[r.No=0]="No",r[r.Pause=1]="Pause",r[r.Force=2]="Force",(d=o||(o={})).LANDSCAPE="landscape",d.PORTRAIT="portrait",(s=l||(l={})).Avatar="1",s.ThumbnailAndAvatar="2",(u=a||(a={})).Viewers="1",u.Comments="2"}}]);