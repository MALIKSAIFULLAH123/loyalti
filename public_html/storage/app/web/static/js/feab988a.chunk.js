"use strict";(self.webpackChunk_metafox_react=self.webpackChunk_metafox_react||[]).push([["formElement.livestreaming"],{43498(e,t,i){let a;i.d(t,{LL:()=>p,Ui:()=>g,ET:()=>b});var r=i(96602),n=i(96540),o=i(91557),l=i(70223),s=i(11497),c=i(656),d=i(78292);let u=new class{bootstrap(e,t){this.manager=e,this.settingApp=this.manager.getSetting("firebase"),this.settingApp&&this.init(this.settingApp,t)}checkActive(){return this.isActive}init(e,t){if(this.mounted)return this.firebaseApp;this.mounted=!0;let i={apiKey:o.z0J,authDomain:o.wRL,projectId:o.wWR,storageBucket:o.npo,messagingSenderId:o.AfL,appId:o.Kou};this.config=e;try{let a=(0,l.Wp)(i),r=(0,c.xI)(a),{user_firebase_email:n,user_firebase_password:s,requiredSignin:d}=this.settingApp||{};return d&&(0,c.x9)(r,n,s).then(e=>{}).catch(e=>{console.log("Live Video - Firebase signInWithEmailAndPassword error",e),"auth/user-not-found"===e.code&&(0,c.eJ)(r,n,s)}),t(!0),this.firebaseApp=a,this.isActive=!0,a}catch(u){this.isActive=!1}}getFirebaseApp(){return this.firebaseApp}getFirestore(){if(!this.firebaseApp)return null;if(!this.firestore){let e=(0,s.aU)(this.firebaseApp);e&&(this.firestore=e)}return this.firestore}getMessaging(){if(!this.firebaseApp)return null;if(!this.cloudMessage){let e=(0,d.dG)(this.firebaseApp);e&&(this.cloudMessage=e)}return this.cloudMessage}},v=!1,f=!1;function m(){let e=(0,o.PCX)(),[t,i]=n.useState(!1);return t||v||(v=!0,u.bootstrap(e,()=>{f=!0,i(!0)})),[t||f,u]}function p(){let[e,t]=n.useState(),[i,o]=n.useState(!1),[l,s]=m(),c=n.useRef(0);if(!l)return["",()=>{},!0];if(!a&&!i&&l)try{a=s.getMessaging()}catch(d){o(!0)}let u=e=>{(0,r.gf)(a).then(i=>{e(i),t(i)}).catch(()=>{c.current>5||(c.current=c.current+1,u(e))})};return[e,u,i]}function g(){let[e,t]=m();if(!e)return!1;let i=t.getFirestore();return i}let h=(e,t)=>{let[i,a]=(0,n.useState)();return(0,n.useEffect)(()=>{let i;if(e&&(null==t?void 0:t.collection)&&(null==t?void 0:t.docID)){try{let r=(0,s.H9)(e,t.collection,t.docID);i=(0,s.aQ)(r,async e=>{a(e.data())})}catch(n){}return()=>{null==i||i()}}},[]),i},b=h},72518(e,t,i){i.r(t),i.d(t,{default:()=>b});var a=i(3556),r=i(8051),n=i(87773),o=i(20687),l=i(84058),s=i.n(l),c=i(96540),d=i(91557),u=i(40515),v=i(30261),f=i(26287),m=i(43498);let p=(0,f.Ay)({resolved:{},chunkName:()=>"VideoPlayer",isReady(e){let t=this.resolve(e);return!0===this.resolved[t]&&!!i.m[t]},importAsync:()=>i.e("VideoPlayer").then(i.bind(i,87951)),requireAsync(e){let t=this.resolve(e);return this.resolved[t]=!1,this.importAsync(e).then(e=>(this.resolved[t]=!0,e))},requireSync(e){let t=this.resolve(e);return i(t)},resolve:()=>null}),g=(0,a.Ay)(r.A,{name:"FieldMuxPlayer",slot:"placeholder"})(({theme:e})=>({position:"relative",backgroundColor:"#333",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center","&:before":{content:'""',display:"block",paddingBottom:"56.25%"}})),h=()=>{let{i18n:e}=(0,d.PCX)();return c.createElement(g,null,c.createElement(n.A,{variant:"body1",sx:{display:"flex",alignItems:"center",flexDirection:"column",justifyContent:"center",fontSize:"24px"}},c.createElement(u.s4,{icon:"ico-videocam",sx:{fontSize:40,mb:2}}),c.createElement(r.A,{ml:1},e.formatMessage({id:"connect_streaming_software_to_go_live"}))))};function b({config:{excludeFields:e,label:t="Reset",align:i="right",size:a,margin:r,fullWidth:n,sxFieldWrapper:l,streamKey:d},name:u,formik:f}){var g;let[,,{setValue:b}]=(0,v.Mt)(null!=u?u:"MuxVideoField"),[y,A]=c.useState(),E=c.useRef(),k=(0,m.Ui)(),w=(0,m.ET)(k,{collection:"live_video",docID:d});c.useEffect(()=>{A(w)},[w]),c.useEffect(()=>{b(null==y?void 0:y.status)},[y]);let _=["waiting","active"].includes(null==y?void 0:y.status);return c.createElement(o.A,{size:a,margin:r,fullWidth:n,"data-testid":s()(`field ${u}`),sx:l},_?c.createElement(p,{playbackId:null==y?void 0:null===(g=y.playback)||void 0===g?void 0:g.playback_id,streamType:"on-demand",ref:E,style:{"--seek-backward-button":"none","--seek-forward-button":"none","--time-display":"none","--playback-rate-button":"none","--pip-button":"none"}}):c.createElement(h,null))}},89953(e,t,i){i.d(t,{A:()=>S});var a=i(91557),r=i(3556),n=i(8051),o=i(87773),l=i(96540),s=i(20687),c=i(89335),d=i(50203),u=i(57660),v=i(84058),f=i.n(v);let m="LivestreamingDeviceOptions",p=(0,r.Ay)(n.A,{name:m,slot:"wrapper"})(({theme:e})=>({display:"flex",margin:e.spacing(-1),"& > *":{flex:1,minWidth:0,padding:e.spacing(1)}})),g=(0,r.Ay)(n.A,{name:m,slot:"root"})(({theme:e})=>({display:"block"})),h=({onDeviceChange:e,sx:t={},defaultValues:i={}})=>{let{i18n:r}=(0,a.PCX)(),[o,v]=(0,l.useState)({video:[],audio:[]}),[m,h]=(0,l.useState)((null==i?void 0:i.video)||""),[b,y]=(0,l.useState)((null==i?void 0:i.audio)||"");return(0,l.useEffect)(()=>{(async function(){let e=await navigator.mediaDevices.enumerateDevices();v({video:e.filter(e=>"videoinput"===e.kind),audio:e.filter(e=>"audioinput"===e.kind)})})()},[]),l.createElement(g,{sx:t},l.createElement(p,null,l.createElement(n.A,null,l.createElement(s.A,{fullWidth:!0},l.createElement(c.A,null,r.formatMessage({id:"camera"})),l.createElement(d.A,{"data-testid":f()("select_camera"),value:m,onChange(t){h(t.target.value),e(t.target.value,b)},label:r.formatMessage({id:"camera"})},o.video.map(e=>l.createElement(u.A,{key:e.deviceId,value:e.deviceId},e.label||`${r.formatMessage({id:"camera"})} ${o.video.indexOf(e)+1}`))))),l.createElement(n.A,null,l.createElement(s.A,{fullWidth:!0},l.createElement(c.A,null,r.formatMessage({id:"microphone"})),l.createElement(d.A,{"data-testid":f()("select_audio"),value:b,onChange(t){y(t.target.value),e(m,t.target.value)},label:r.formatMessage({id:"microphone"})},o.audio.map(e=>l.createElement(u.A,{key:e.deviceId,value:e.deviceId},e.label||`${r.formatMessage({id:"microphone"})} ${o.video.indexOf(e)+1}`)))))))};var b=i(40515),y=i(2404),A=i.n(y);let E="LivestreamWebcam",k=(0,r.Ay)(n.A,{name:E,slot:"root"})(({theme:e})=>({position:"relative",display:"block","& video":{width:"100%"}})),w=(0,r.Ay)(n.A,{name:E,slot:"placeholder"})(({theme:e})=>({position:"relative",backgroundColor:"#333",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center","& video":{position:"absolute",top:0,left:0,width:"100%",height:"100%"},"&:before":{content:'""',display:"block",paddingBottom:"56.25%"}})),_=()=>{let{i18n:e}=(0,a.PCX)();return l.createElement(w,null,l.createElement(o.A,{variant:"body1",sx:{display:"flex",alignItems:"center",flexDirection:"column",justifyContent:"center",fontSize:"24px"}},l.createElement(b.s4,{icon:"ico-videocam",sx:{fontSize:40,mb:2}}),l.createElement(n.A,{ml:1},e.formatMessage({id:"connect_devices_to_go_live"}))))},x=({onReady:e,streamKey:t,sxDeviceWrapper:i,deviceDefault:r,id:o})=>{let{dispatch:s,getSetting:c,livestreamingSocket:d,dialogBackend:u,i18n:v,setNavigationConfirm:f}=(0,a.PCX)(),m=l.useRef(null),p=l.useRef(null),g=l.useRef(void 0),{per_time_recorder_webcam:b=1e3}=c("livestreaming"),y=l.useRef(null),E=d.getStatus(),[x,S]=l.useState("initialized"===E),[M,C]=l.useState(!1),[I,R]=l.useState(r),D=l.useCallback(()=>{let e=navigator.connection,t=(null==e?void 0:e.effectiveType)||"4g",i={"4g":{video:25e5,audio:128e3,framerate:30},"3g":{video:1e6,audio:64e3,framerate:24},"2g":{video:5e5,audio:32e3,framerate:15}};return i[t]||i["4g"]},[]),P=l.useCallback(e=>{var t;let i=window.performance,a=(null===(t=i.memory)||void 0===t?void 0:t.usedJSHeapSize)>5e8;return{width:{ideal:a?854:1280},height:{ideal:a?480:720},frameRate:{ideal:e.framerate}}},[]),T=l.useCallback(()=>{for(let e of["video/webm; codecs=vp9,opus","video/webm; codecs=vp8,opus","video/mp4; codecs=h264,aac"])if(MediaRecorder.isTypeSupported(e))return e;for(let t of["video/webm; codecs=vp9","video/webm; codecs=vp8","video/webm","video/mp4"])if(MediaRecorder.isTypeSupported(t))return t;return"video/webm"},[]),z=l.useCallback(async()=>{if(!t||!d)return!0;let e=await d.waitDdpMethod({name:"streaming",id:"result/streaming",params:[t]});return!e.error||(u.alert({message:e.msg?v.formatMessage({id:e.msg}):void 0}),!1)},[t,d,u,v]),W=l.useCallback(e=>{let t=D(),i=T(),a=e.getAudioTracks().length>0,r=i.includes("opus")||i.includes("aac"),n=new MediaRecorder(e,{mimeType:i,videoBitsPerSecond:t.video,audioBitsPerSecond:a&&r?t.audio:0});return g.current&&d&&(n.ondataavailable=async e=>{e.data.size>0&&d&&d.sendRaw(e.data)}),n},[D,T,d]),L=l.useCallback(()=>{if(!y.current||!p.current)return;p.current.stop();let e=W(y.current);p.current=e,e.start(b)},[W,b]);l.useEffect(()=>{let e=navigator.connection;if(e)return e.addEventListener("change",L),()=>e.removeEventListener("change",L)},[L]);let F=async()=>{y.current&&y.current.getTracks().forEach(e=>e.stop());let i=null==I?void 0:I.video,a=null==I?void 0:I.audio;try{if(t){g.current=t;let r=await z();if(!r)return}let n=D(),o=P(n),l=await navigator.mediaDevices.getUserMedia({video:{deviceId:i?{exact:i}:void 0,...o},audio:{deviceId:a?{exact:a}:void 0,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});C(!0);let s=l.getVideoTracks()[0],c=l.getAudioTracks()[0],d={video:null==s?void 0:s.getSettings().deviceId,audio:null==c?void 0:c.getSettings().deviceId};A()(d,I)||R(d),m.current&&(m.current.srcObject=l),y.current=l,e&&e(d);let u=W(l);p.current=u,u.start(b)}catch(h){console.error("Error starting stream webcam:",h);try{let v=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:15}},audio:{deviceId:a?{exact:a}:void 0,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});m.current&&(m.current.srcObject=v),y.current=v}catch(f){console.error("Fallback stream failed:",f)}}},j=(e,t)=>{R({video:e,audio:t})};return l.useEffect(()=>(s({type:"livestreaming/socket/init",meta:{onSuccess(){S(!0)}}}),t&&(f(!0,{message:v.formatMessage({id:"live_video_is_on_going_are_you_sure_to_leave_now"})},()=>{s({type:"livestreaming/end-live/force",payload:{id:o}})}),window.onbeforeunload=()=>v.formatMessage({id:"live_video_is_on_going_are_you_sure_to_leave_now"})),()=>{y.current&&y.current.getTracks().forEach(e=>e.stop()),t&&(d.close(),window.onbeforeunload=void 0,f(!1))}),[]),l.useEffect(()=>{x&&F()},[x,null==I?void 0:I.video,null==I?void 0:I.audio]),l.createElement(k,null,l.createElement(n.A,null,M?null:l.createElement(_,null),l.createElement(w,{sx:{display:M?"block":"none"}},l.createElement("video",{ref:m,autoPlay:!0,playsInline:!0,controls:!1,muted:!0})),I?l.createElement(h,{defaultValues:I,sx:i,onDeviceChange:j}):null))},S=x},71336(e,t,i){i.r(t),i.d(t,{default:()=>c});var a=i(20687),r=i(84058),n=i.n(r),o=i(96540),l=i(30261),s=i(89953);function c({config:{size:e,margin:t="normal",fullWidth:i,sxFieldWrapper:r,streamKey:c},name:d,formik:u}){let[,,{setValue:v}]=(0,l.Mt)(null!=d?d:"MuxVideoField"),f=e=>{let{video:t,audio:i}=e||{};v({video:t,audio:i})};return o.createElement(a.A,{size:e,margin:t,fullWidth:i,"data-testid":n()(`field ${d}`),sx:r},o.createElement(s.A,{onReady:f,sxDeviceWrapper:{mt:2}}))}}}]);