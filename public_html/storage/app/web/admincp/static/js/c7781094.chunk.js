(self.webpackChunk_metafox_react=self.webpackChunk_metafox_react||[]).push([["metafox-story-blocks-ViewStory-Block"],{24713(e,t,i){var o=i(2523),n=i(15389),a=i(61489),l=Math.max;e.exports=function(e,t,i){var r=null==e?0:e.length;if(!r)return -1;var d=null==i?0:a(i);return d<0&&(d=l(r+d,0)),o(e,n(t,3),d)}},85011(e,t,i){"use strict";i.r(t),i.d(t,{default:()=>_});var o=i(91557),n=i(84680),a=i(44562),l=i(32113),r=i(51147),d=i(85332),s=i(91262),u=i(3556),v=i(8051),y=i(62193),c=i.n(y),p=i(96540),f=i(71468);let g="StoryViewBlock",m=(0,u.Ay)(v.A,{name:g,slot:"Root",overridesResolver:(e,t)=>[t.root]})(({theme:e})=>({display:"flex",width:"100%",height:"100%"})),S=(0,u.Ay)(v.A,{name:g,slot:"SideBarWrapper",overridesResolver:(e,t)=>[t.buddyWrap]})(({theme:e})=>({width:"360px",backgroundColor:e.palette.background.paper})),A=(0,u.Ay)(v.A,{name:g,slot:"room-wrap"})(({theme:e})=>({flex:1,minWidth:0,display:"flex",justifyContent:"center",alignItems:"center"})),h=(0,o.WvA)({name:"StoryViewBlock",extendBlock:function(e){let{jsxBackend:t,dispatch:i,createErrorPage:u,useGetItem:v}=(0,o.PCX)(),y=p.useRef(!1),g=p.useRef(),[h,_]=(0,p.useReducer)(r.l,{...l.x6}),{isReady:b,listUserStories:R,identityStoryActive:x,identityUserStoryActive:k,pauseStatus:w}=h||{},{muted:I,isEditMuted:O=!1}=(0,d.F_)(),P=v(k),C=v(x),L=(0,o.UfA)(null==P?void 0:P.stories),E=p.useRef(!1),F=(0,f.d4)(e=>(0,o.qRQ)(e,a.Qz)),U=null==L?void 0:L.findIndex(e=>(null==e?void 0:e.id)===(null==C?void 0:C.id)),Z=p.useMemo(()=>L.length-1===U,[L,U]),V=t.get("story.block.sidebarHomeStory"),M=t.get("story.block.mainViewHome"),B=t.get("story.block.sideStoryHeader");if(p.useEffect(()=>{_({type:"setReady",payload:!1})},[]),p.useEffect(()=>{var e,t;if(E.current||!(null==L?void 0:L.length))return;E.current=!0;let i=null==L?void 0:L.findIndex(e=>{var t;return e.type===a.UZ&&null!=e&&null!==(t=e.extra_params)&&void 0!==t&&!!t.is_streaming||!1===e.has_seen});_({type:"setIdentityStoryActive",payload:-1===i?null===(e=L[0])||void 0===e?void 0:e._identity:null===(t=L[i])||void 0===t?void 0:t._identity})},[null==L?void 0:L.length]),p.useEffect(()=>{var e,t;let i=null==L?void 0:L.findIndex(e=>{var t;return e.type===a.UZ&&null!=e&&null!==(t=e.extra_params)&&void 0!==t&&!!t.is_streaming||!1===e.has_seen});_({type:"setIdentityStoryActive",payload:-1===i?null===(e=L[0])||void 0===e?void 0:e._identity:null===(t=L[i])||void 0===t?void 0:t._identity})},[null==P?void 0:P.id,null==R?void 0:R.length]),p.useEffect(()=>{if(!c()(C)){if(!(null==C?void 0:C.in_process)&&!C.has_seen){var e,t;if(!b&&!(null===(e=window.navigator)||void 0===e?void 0:null===(t=e.userActivation)||void 0===t?void 0:t.hasBeenActive))return;i({type:"story/updateView",payload:{story:C,lastStory:Z,identityUser:k}})}_({type:"setReactions",payload:[]}),_({type:"setOpenViewComment",payload:!1})}},[null==C?void 0:C._identity,Z,b]),p.useEffect(()=>{var e,t;!c()(C)&&O&&(null===(e=window.navigator)||void 0===e?void 0:null===(t=e.userActivation)||void 0===t?void 0:t.hasBeenActive)&&_({type:"setMuted",payload:I})},[O,I,_,C]),null==F?void 0:F.error)return u(null==F?void 0:F.error,{loginRequired:!0});let D=()=>{w!==s.ZR.Force&&_({type:"setForcePause",payload:s.ZR.Pause})},T=()=>{w!==s.ZR.Force&&_({type:"setForcePause",payload:s.ZR.No})},$=e=>{if(w!==s.ZR.Force){if(e.relatedTarget!==e.currentTarget&&!e.currentTarget.contains(e.relatedTarget)){y.current=!0,_({type:"setForcePause",payload:s.ZR.Pause}),_({type:"setOpenActionItem",payload:!0});return}_({type:"setForcePause",payload:s.ZR.No}),_({type:"setOpenActionItem",payload:!1})}},N=e=>{w!==s.ZR.Force&&y.current&&(g.current=setTimeout(()=>{_({type:"setForcePause",payload:s.ZR.No}),_({type:"setOpenActionItem",payload:!1}),y.current=!1},300))},H=e=>{clearTimeout(g.current)};return p.createElement(l.MO.Provider,{value:{...h,fire:_,indexStoryActive:U}},p.createElement(m,null,p.createElement(S,{onMouseEnter:D,onMouseLeave:T},p.createElement(n.P,{autoHide:!0,autoHeight:!0,autoHeightMax:"100%"},p.createElement(B,null),p.createElement(V,null))),p.createElement(A,{onBlur:$,onMouseEnter:N,onMouseLeave:H,tabIndex:0},p.createElement(M,null))))}}),_=h},32113(e,t,i){"use strict";i.d(t,{vZ:()=>l,MO:()=>d,x6:()=>s});var o=i(91262),n=i(96540);let a=n.createContext({status:null,setStatus(){},setFilePhoto(){},filePhoto:null,setUploading(){},uploading:!1,setIsDirty(){},isDirty:!1,isSubmitting:!1,setIsSubmitting(){}}),l=a,r=n.createContext({}),d=r,s={identityStoryActive:void 0,identityUserStoryActive:void 0,listUserStories:[],pauseStatus:o.ZR.No,reactions:[],indexStoryActive:void 0,openStoryDetail:!1,openViewComment:!1,openActionItem:!1,readyStateFile:!1,progressVideoPlay:0,isLastStory:!1,isReady:!1,mutedStatus:!0,buffer:!1}},51147(e,t,i){"use strict";i.d(t,{l:()=>n});var o=i(16535);let n=(0,o.Ay)((e,t)=>{switch(t.type){case"setListUserStories":e.listUserStories=t.payload;break;case"setReactions":e.reactions=t.payload;break;case"setIdentityStoryActive":e.identityStoryActive=t.payload;break;case"setIdentityUserS_Active":e.identityUserStoryActive=t.payload;break;case"setForcePause":e.pauseStatus=t.payload;break;case"setOpenStoryDetail":e.openStoryDetail=t.payload;break;case"setOpenViewComment":e.openViewComment=t.payload;break;case"setOpenActionItem":e.openActionItem=t.payload;break;case"setReadyStateFile":e.readyStateFile=t.payload;break;case"setProgressVideoPlay":e.progressVideoPlay=t.payload;break;case"setIndexStoryActive":e.indexStoryActive=t.payload;break;case"setLastStory":e.isLastStory=t.payload;break;case"setReady":e.isReady=t.payload;break;case"setMuted":e.mutedStatus=t.payload;break;case"setDuration":e.durationVideo=t.payload;break;case"setBuffer":e.buffer=t.payload}})},79655(e,t,i){"use strict";i.d(t,{A:()=>c,n:()=>v});var o=i(91557),n=i(24713),a=i.n(n),l=i(58156),r=i.n(l),d=i(44562),s=i(95093),u=i.n(s);let v=(e,t,i=3)=>t<i?"prev":t>e-i-1?"next":"",y=(e,t)=>{let{identity:i}=t,o=r()(e,i),n=new URL(window.location.href),l=new URLSearchParams(n.search).get("date");if(!o)return{};let s=u()(l).format("L"),y=`${d.Lp}/${s}`,c=r()(e,`pagination.${y}.ids`),p=r()(e,`pagination.${y}.pagesOffset.total`),f=r()(e,`pagination.${y}.ended`),g=r()(e,`pagination.${y}.pagesOffset.next_date`),m=r()(e,`pagination.${y}.pagesOffset.prev_date`),S=f?1:r()(e,`pagination.${y}.pagesOffset.current_page`),A=r()(e,`pagination.${y}.pagesOffset.per_page`),h=(null==o?void 0:o.user)?r()(e,o.user):void 0,_=null==c?void 0:c.length,b=1<_?a()(c,e=>e===i):-1,R=-1!==b?b:0,x=f?R:r()(e,`pagination.${y}.pagesOffset.pos`)||0,k={item:o,stories:c,user:h,total:p,nextDate:g,prevDate:m,pagingId:y,date:l,indexStoryActive:R,positionStory:A*(S-1)+x,shouldPreload:v(_,x+1)};return k},c=(0,o.NgA)(y)},85332(e,t,i){"use strict";i.d(t,{Ay:()=>v,F_:()=>f,P3:()=>c,Tq:()=>g,Uf:()=>p,aN:()=>A,vC:()=>y});var o=i(96540),n=i(32113),a=i(91557),l=i(44562),r=i(71468),d=i(69634),s=i(79655),u=i(1081);function v(){return o.useContext(n.vZ)}function y(){return o.useContext(n.MO)}function c(){var e,t;let{navigate:i,useGetItem:n}=(0,a.PCX)(),{listUserStories:l,identityUserStoryActive:r,identityStoryActive:d,fire:s}=y(),u=n(r),v=n(d),c=(0,a.UfA)(null==u?void 0:u.stories),p=null==c?void 0:c.findIndex(e=>(null==e?void 0:e.id)===(null==v?void 0:v.id)),f=null==l?void 0:l.findIndex(e=>(null==e?void 0:e.id)===(null==u?void 0:u.id)),g=(null==c?void 0:null===(e=c[0])||void 0===e?void 0:e.id)===(null==v?void 0:v.id),m=(null==u?void 0:u.stories.length)-1===p,S=(null==l?void 0:null===(t=l[0])||void 0===t?void 0:t.id)===(null==u?void 0:u.id)&&g,A=(null==l?void 0:l.length)-1===f&&m,h=!S,_=!A,b=o.useCallback(()=>{var e,t;if(h&&-1!==p){if(g){s({type:"setIdentityUserS_Active",payload:null===(t=l[f-1])||void 0===t?void 0:t._identity});return}s({type:"setIdentityStoryActive",payload:null==c?void 0:null===(e=c[p-1])||void 0===e?void 0:e._identity})}},[h,p,g,l,c,f]),R=o.useCallback(()=>{var e,t;if(A){i("/");return}if(_&&-1!==p){if(m){s({type:"setIdentityUserS_Active",payload:null===(t=l[f+1])||void 0===t?void 0:t._identity});return}s({type:"setIdentityStoryActive",payload:null==c?void 0:null===(e=c[p+1])||void 0===e?void 0:e._identity})}},[A,_,p,m,l,f,c]);return{hasPrev:h,hasNext:_,handlePrev:b,handleNext:R}}function p(e){let[t,i]=o.useState(0),[n,a]=o.useState(0),r=o.useRef(),d=o.useCallback(()=>{var o;if(!(null==e?void 0:e.current))return[t,n];let r=null==e?void 0:null===(o=e.current)||void 0===o?void 0:o.getBoundingClientRect(),d=(null==r?void 0:r.height)/l.us,s=null==r?void 0:r.height;window.screen.width<=d&&(s=(d=window.screen.width)*l.us),a(s),i(d)},[null==e?void 0:e.current]);return o.useEffect(()=>{var t;let i=e.current;if(i)return r.current=new ResizeObserver(()=>{d()}),d(),null===(t=r.current)||void 0===t||t.observe(i),()=>{null==r||r.current.disconnect()}},[d,null==e?void 0:e.current]),[t,n,d]}function f(){return(0,r.d4)(e=>(0,d.s)(e))}function g(){var e,t;let i=y(),{fire:n,stories:l,indexStoryActive:d,nextDate:u,prevDate:v,identityStoryActive:c,loading:p,total:f,positionStory:g,pagingId:m}=i,S=(0,r.d4)(e=>(0,a.qRQ)(e,m))||{},{prev_page:A,last_page:h,current_page:_}=(null==S?void 0:S.pagesOffset)||{},{useGetItem:b,useGetItems:R,dispatch:x,usePageParams:k}=(0,a.PCX)(),w=k(),I=b(c),O=R(l),P=(null==O?void 0:null===(e=O[0])||void 0===e?void 0:e.id)===(null==I?void 0:I.id)&&0===A,C=(null==l?void 0:l[(null==l?void 0:l.length)-1])===c&&h===_,L=!(!v&&P),E=!(!u&&C),F=(null==l?void 0:l[(null==l?void 0:l.length)-1])===c&&h!==_,U=(null==O?void 0:null===(t=O[0])||void 0===t?void 0:t.id)===(null==I?void 0:I.id)&&0!==A,Z=(e,t=()=>{})=>{var o;let a=e=>{var t;let i=null==e?void 0:e.pagingId,o=null==e?void 0:e.ids;if(!i||!(null==o?void 0:o.length))return;let a=null==e?void 0:null===(t=e.pagesOffset)||void 0===t?void 0:t.total;n({type:"setInit",payload:{stories:o,total:a,loading:!1}})},l=(0,s.n)(null==i?void 0:null===(o=i.stories)||void 0===o?void 0:o.length,e);if(!l){t&&t();return}t&&t(),x({type:"story/story_archive/LOAD",payload:{user_id:null==w?void 0:w.user_id,date:null==i?void 0:i.date,direction:l},meta:{onSuccess:a}})},V=(e,t)=>{var i,o,a;let l=null==e?void 0:e.pagingId,r=null==e?void 0:e.ids;if(!l||!(null==r?void 0:r.length))return;let d=null==e?void 0:null===(i=e.pagesOffset)||void 0===i?void 0:i.total,s=null==e?void 0:null===(o=e.pagesOffset)||void 0===o?void 0:o.next_date,u=null==e?void 0:null===(a=e.pagesOffset)||void 0===a?void 0:a.prev_date;n({type:"setLoading",payload:!1}),n({type:"setInit",payload:{isReady:!1,stories:r,total:d,nextDate:s,prevDate:u,indexStoryActive:0,positionStory:0,identityStoryActive:null==r?void 0:r[0],pagingId:l,date:t}})},M=()=>{n({type:"setLoading",payload:!1})},B=o.useCallback(()=>{if(U&&n({type:"setLoading",payload:!0}),!p&&L&&!U){if(P){n({type:"setLoading",payload:!0}),x({type:"story/story_archive/LOAD",payload:{user_id:null==w?void 0:w.user_id,date:v},meta:{onSuccess:e=>V(e,v),onError:M}});return}Z(d-1),n({type:"setStoryActive",payload:{identity:null==l?void 0:l[d-1],index:d-1,positionStory:g-1}})}},[L,l,d,P,p,U,Z,g,O,v]),D=o.useCallback(()=>{if(F&&n({type:"setLoading",payload:!0}),!p&&E&&!F){if(C){n({type:"setLoading",payload:!0}),x({type:"story/story_archive/LOAD",payload:{user_id:null==w?void 0:w.user_id,date:u},meta:{onSuccess:e=>V(e,u),onError:M}});return}Z(d+1),n({type:"setStoryActive",payload:{identity:null==l?void 0:l[d+1],index:d+1,positionStory:g+1}})}},[E,l,d,C,f,F,p,Z,u,g,O]);return{hasPrev:L,hasNext:E,handlePrev:B,handleNext:D,loadmore:Z}}let m=e=>(e.preaction.data.reactions||[]).filter(e=>e.is_active),S=(0,u.Mz)(m,e=>e);function A(){return(0,r.d4)(S)}},91262(e,t,i){"use strict";var o,n,a,l,r,d,s,u;i.d(t,{ZR:()=>o,Zw:()=>n,dw:()=>l,gw:()=>a}),(r=o||(o={}))[r.No=0]="No",r[r.Pause=1]="Pause",r[r.Force=2]="Force",(d=n||(n={})).LANDSCAPE="landscape",d.PORTRAIT="portrait",(s=a||(a={})).Avatar="1",s.ThumbnailAndAvatar="2",(u=l||(l={})).Viewers="1",u.Comments="2"}}]);