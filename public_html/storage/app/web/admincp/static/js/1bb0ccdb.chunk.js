"use strict";(self.webpackChunk_metafox_react=self.webpackChunk_metafox_react||[]).push([["composer.Chatplus"],{22598(e,t,l){l.r(t),l.d(t,{default:()=>p});var o=l(97837),r=l(91557),n=l(96540);let i={editorPlugins:[{as:"statusComposerChat.plugin.mention"}],editorControls:[{as:"lexical.control.attachEmoji"},{as:"commentComposer.control.attachFile",showWhen:["and",["falsy","editing"],["falsy","previewFiles"],["falsy","isBotRoom"]]},{as:"chatComposer.control.buttonSubmit"}]};var a=l(67725),u=l(36338),s=l(53579),c=l(99087),d=l(10335),v=l(62193),m=l.n(v);let p=n.forwardRef(function({rid:e,room:t,user:l,msgId:v,text:p="",focus:f,reactMode:g,onSuccess:h,margin:y="normal",subscription:C,previewRef:b,isAllPage:R},x){let{i18n:_,dispatch:k,jsxBackend:w,chatplus:E}=(0,r.PCX)(),M=(0,r.ZCR)(g),S=n.useRef(!0),P=n.useRef({}),[T,F]=n.useState(p?(0,u.Nj)(p):""),[B,K]=n.useState(!1),[j,N]=n.useState([]),U=n.useMemo(()=>({editing:"edit"===g,previewFiles:j.length,isBotRoom:null==t?void 0:t.isBotRoom}),[g,j,null==t?void 0:t.isBotRoom]),[Z,,$]=function(e,t,l,o,i){let{jsxBackend:u}=(0,r.PCX)(),s=(0,n.useRef)([]),c=(0,n.useRef)([]),d=i?[l,null==o?void 0:o.id,t]:[t];return(0,n.useMemo)(()=>{o&&l&&e.editorPlugins.forEach(e=>{let t=u.get(e.as);t&&"function"==typeof t&&t(s.current,c.current,l,o)});let r=e.editorControls?(0,a.Zk)((0,a.Ue)(e.editorControls,t),t):[],n=e.attachers?(0,a.Zk)((0,a.Ue)(e.attachers,t),t):[];return[s.current,c.current,r,n]},d)}(i,U,e,t,R),D=(null==t?void 0:t.t)!==o.CJ.Direct?_.formatMessage({id:"type_a_message_or__name"}):_.formatMessage({id:"write_a_message"});(0,n.useEffect)(()=>{if(O(),S.current){S.current=!1,p&&k({type:"chatplus/room/text",payload:{rid:e,text:""}});return}I(!1)},[e]),n.useEffect(()=>{if("edit"===g){let e=p?(0,u.Nj)(p):"";F(e),O()}"reply"===g&&O(),"no_react"===g&&"edit"===M&&F("")},[p,g,e,v]);let I=(e=!0)=>{var t,l,o,r,n;e&&(null===(r=P.current)||void 0===r||null===(n=r.editor)||void 0===n||n.blur()),F(""),N([]),(null===(t=b.current)||void 0===t?void 0:t.clear)&&b.current.clear(),null===(l=P.current)||void 0===l||null===(o=l.editor)||void 0===o||o.update(()=>{let e=(0,s.$getRoot)();e.clear()})},H=n.useMemo(()=>({onSuccess(){I(),K(!1),"function"==typeof h&&h()}}),[I]),O=n.useCallback(()=>{setImmediate(()=>{var e,t;return null===(e=P.current)||void 0===e?void 0:null===(t=e.editor)||void 0===t?void 0:t.focus()})},[C]),X=()=>(0,d.ci)(T).trim(),A=()=>{let t=X();t&&!B&&(K(!0),k({type:"chatplus/composer/SUBMIT",payload:{reactMode:g,rid:e,msgId:v,text:t},meta:H}))},J=()=>{var e;null===(e=b.current)||void 0===e||e.clear(),N([]),I(),"no_react"!==g&&h()},W=n.useRef(!1),q=n.useRef(null),z=t=>{let o={typingUser:{name:null==l?void 0:l.name,username:null==l?void 0:l.username,avatarETag:null==l?void 0:l.avatarETag}};!t.keyCode||13!==t.keyCode||t.metaKey||t.shiftKey||t.altKey||t.ctrlKey?(W.current||(W.current=!0,E.typingMessage(e,l.username,!0,o)),clearTimeout(q.current),q.current=setTimeout(()=>{W.current=!1,E.typingMessage(e,l.username,!1,o)},5e3)):(clearTimeout(q.current),E.typingMessage(e,l.username,!1,o),W.current=!1)},G=()=>{var e,t;m()(null==P?void 0:null===(e=P.current)||void 0===e?void 0:e.editor)||null===(t=P.current)||void 0===t||t.editor.update(()=>{var e,t,l;let o=(0,s.$getSelection)();if(!o)return;let r=null==o?void 0:o.anchor,[n]=(null==o?void 0:o.getNodes())||[];if(!n)return;let i=null==n?void 0:n.getPreviousSibling(),a=null==n?void 0:n.getTextContent(),u=(0,s.$isTextNode)(n)&&(null==n?void 0:n.isSimpleText()),c=null==r?void 0:r.offset,v=null!==(l=null===(t=null===(e=null==a?void 0:a.substring(0,c))||void 0===e?void 0:e.split(/\s+/))||void 0===t?void 0:t.at(-1))&&void 0!==l?l:"";u&&(0,d.d3)(i)&&1===c&&v&&n.insertBefore((0,s.$createTextNode)(" "))})},L=()=>{if(j&&j.length&&Object.values(j).length){let t=X();k({type:"chatplus/composer/upload",payload:{files:Object.values(j),rid:e,text:t,reactMode:g,msgId:v},meta:{onSuccess:J}})}else A()};n.useEffect(()=>{f&&O()},[f,O]),n.useImperativeHandle(x,()=>({attachFiles(e){(null==e?void 0:e.length)&&N(e)},removeFile(e){let t=[...j];e>-1&&(t.splice(e,1),N([...t]))},getPreviewFiles:()=>j}));let Q=n.useMemo(()=>{let e=X();return!!((null==j?void 0:j.length)||e)},[j,T]),V=e=>{if(e.length&&b&&b.current){var t;N([...j,...e]),null===(t=b.current)||void 0===t||t.attachFiles([...j,...e])}},Y=e=>{F(e)};return n.createElement(c.v4,{margin:y},n.createElement(c.sM,{onClick:O},t?n.createElement(d.yZ,{handleSubmit:L,onChange:Y,onKeyDown:z,onBeforeKeyDown:G,value:T,editorRef:P,placeholder:D,handlePastedFiles:V,sx:{border:0,padding:"6px 12px",background:"none",overflow:"visible",minHeight:"32px"},editorPlugins:Z}):null),n.createElement(c.dA,null,$.map(t=>w.render({component:t.as,props:{key:t.as,previewRef:b,filesUploadRef:x,control:c.uP,editorRef:P,rid:e,disableSubmit:Q,handleSubmit:L,disablePortal:!0,placement:"top"}}))))})}}]);