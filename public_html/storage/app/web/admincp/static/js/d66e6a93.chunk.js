"use strict";(self.webpackChunk_metafox_react=self.webpackChunk_metafox_react||[]).push([["formElement.livestreaming"],{43498(e,t,i){i.d(t,{Ui:()=>v,ET:()=>f}),i(96602);var a=i(96540),r=i(91557),n=i(70223),o=i(11497),l=i(656),s=i(78292);let d=new class{bootstrap(e,t){this.manager=e,this.settingApp=this.manager.getSetting("firebase"),this.settingApp&&this.init(this.settingApp,t)}checkActive(){return this.isActive}init(e,t){if(this.mounted)return this.firebaseApp;this.mounted=!0;let i={apiKey:r.z0J,authDomain:r.wRL,projectId:r.wWR,storageBucket:r.npo,messagingSenderId:r.AfL,appId:r.Kou};this.config=e;try{let a=(0,n.Wp)(i),o=(0,l.xI)(a),{user_firebase_email:s,user_firebase_password:d,requiredSignin:c}=this.settingApp||{};return c&&(0,l.x9)(o,s,d).then(e=>{}).catch(e=>{console.log("Live Video - Firebase signInWithEmailAndPassword error",e),"auth/user-not-found"===e.code&&(0,l.eJ)(o,s,d)}),t(!0),this.firebaseApp=a,this.isActive=!0,a}catch(u){this.isActive=!1}}getFirebaseApp(){return this.firebaseApp}getFirestore(){if(!this.firebaseApp)return null;if(!this.firestore){let e=(0,o.aU)(this.firebaseApp);e&&(this.firestore=e)}return this.firestore}getMessaging(){if(!this.firebaseApp)return null;if(!this.cloudMessage){let e=(0,s.dG)(this.firebaseApp);e&&(this.cloudMessage=e)}return this.cloudMessage}},c=!1,u=!1;function v(){let[e,t]=function(){let e=(0,r.PCX)(),[t,i]=a.useState(!1);return t||c||(c=!0,d.bootstrap(e,()=>{u=!0,i(!0)})),[t||u,d]}();if(!e)return!1;let i=t.getFirestore();return i}let m=(e,t)=>{let[i,r]=(0,a.useState)();return(0,a.useEffect)(()=>{let i;if(e&&(null==t?void 0:t.collection)&&(null==t?void 0:t.docID)){try{let a=(0,o.H9)(e,t.collection,t.docID);i=(0,o.aQ)(a,async e=>{r(e.data())})}catch(n){}return()=>{null==i||i()}}},[]),i},f=m},72518(e,t,i){i.r(t),i.d(t,{default:()=>b});var a=i(3556),r=i(8051),n=i(87773),o=i(20687),l=i(84058),s=i.n(l),d=i(96540),c=i(91557),u=i(40515),v=i(30261),m=i(26287),f=i(43498);let p=(0,m.Ay)({resolved:{},chunkName:()=>"VideoPlayer",isReady(e){let t=this.resolve(e);return!0===this.resolved[t]&&!!i.m[t]},importAsync:()=>i.e("VideoPlayer").then(i.bind(i,87951)),requireAsync(e){let t=this.resolve(e);return this.resolved[t]=!1,this.importAsync(e).then(e=>(this.resolved[t]=!0,e))},requireSync(e){let t=this.resolve(e);return i(t)},resolve:()=>null}),g=(0,a.Ay)(r.A,{name:"FieldMuxPlayer",slot:"placeholder"})(({theme:e})=>({position:"relative",backgroundColor:"#333",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center","&:before":{content:'""',display:"block",paddingBottom:"56.25%"}})),h=()=>{let{i18n:e}=(0,c.PCX)();return d.createElement(g,null,d.createElement(n.A,{variant:"body1",sx:{display:"flex",alignItems:"center",flexDirection:"column",justifyContent:"center",fontSize:"24px"}},d.createElement(u.s4,{icon:"ico-videocam",sx:{fontSize:40,mb:2}}),d.createElement(r.A,{ml:1},e.formatMessage({id:"connect_streaming_software_to_go_live"}))))};function b({config:{excludeFields:e,label:t="Reset",align:i="right",size:a,margin:r,fullWidth:n,sxFieldWrapper:l,streamKey:c},name:u,formik:m}){var g;let[,,{setValue:b}]=(0,v.Mt)(null!=u?u:"MuxVideoField"),[y,A]=d.useState(),E=d.useRef(),k=(0,f.Ui)(),w=(0,f.ET)(k,{collection:"live_video",docID:c});d.useEffect(()=>{A(w)},[w]),d.useEffect(()=>{b(null==y?void 0:y.status)},[y]);let _=["waiting","active"].includes(null==y?void 0:y.status);return d.createElement(o.A,{size:a,margin:r,fullWidth:n,"data-testid":s()(`field ${u}`),sx:l},_?d.createElement(p,{playbackId:null==y?void 0:null===(g=y.playback)||void 0===g?void 0:g.playback_id,streamType:"on-demand",ref:E,style:{"--seek-backward-button":"none","--seek-forward-button":"none","--time-display":"none","--playback-rate-button":"none","--pip-button":"none"}}):d.createElement(h,null))}},89953(e,t,i){i.d(t,{A:()=>S});var a=i(91557),r=i(3556),n=i(8051),o=i(87773),l=i(96540),s=i(20687),d=i(89335),c=i(50203),u=i(57660),v=i(84058),m=i.n(v);let f="LivestreamingDeviceOptions",p=(0,r.Ay)(n.A,{name:f,slot:"wrapper"})(({theme:e})=>({display:"flex",margin:e.spacing(-1),"& > *":{flex:1,minWidth:0,padding:e.spacing(1)}})),g=(0,r.Ay)(n.A,{name:f,slot:"root"})(({theme:e})=>({display:"block"})),h=({onDeviceChange:e,sx:t={},defaultValues:i={}})=>{let{i18n:r}=(0,a.PCX)(),[o,v]=(0,l.useState)({video:[],audio:[]}),[f,h]=(0,l.useState)((null==i?void 0:i.video)||""),[b,y]=(0,l.useState)((null==i?void 0:i.audio)||"");return(0,l.useEffect)(()=>{(async function(){let e=await navigator.mediaDevices.enumerateDevices();v({video:e.filter(e=>"videoinput"===e.kind),audio:e.filter(e=>"audioinput"===e.kind)})})()},[]),l.createElement(g,{sx:t},l.createElement(p,null,l.createElement(n.A,null,l.createElement(s.A,{fullWidth:!0},l.createElement(d.A,null,r.formatMessage({id:"camera"})),l.createElement(c.A,{"data-testid":m()("select_camera"),value:f,onChange(t){h(t.target.value),e(t.target.value,b)},label:r.formatMessage({id:"camera"})},o.video.map(e=>l.createElement(u.A,{key:e.deviceId,value:e.deviceId},e.label||`${r.formatMessage({id:"camera"})} ${o.video.indexOf(e)+1}`))))),l.createElement(n.A,null,l.createElement(s.A,{fullWidth:!0},l.createElement(d.A,null,r.formatMessage({id:"microphone"})),l.createElement(c.A,{"data-testid":m()("select_audio"),value:b,onChange(t){y(t.target.value),e(f,t.target.value)},label:r.formatMessage({id:"microphone"})},o.audio.map(e=>l.createElement(u.A,{key:e.deviceId,value:e.deviceId},e.label||`${r.formatMessage({id:"microphone"})} ${o.video.indexOf(e)+1}`)))))))};var b=i(40515),y=i(2404),A=i.n(y);let E="LivestreamWebcam",k=(0,r.Ay)(n.A,{name:E,slot:"root"})(({theme:e})=>({position:"relative",display:"block","& video":{width:"100%"}})),w=(0,r.Ay)(n.A,{name:E,slot:"placeholder"})(({theme:e})=>({position:"relative",backgroundColor:"#333",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center","& video":{position:"absolute",top:0,left:0,width:"100%",height:"100%"},"&:before":{content:'""',display:"block",paddingBottom:"56.25%"}})),_=()=>{let{i18n:e}=(0,a.PCX)();return l.createElement(w,null,l.createElement(o.A,{variant:"body1",sx:{display:"flex",alignItems:"center",flexDirection:"column",justifyContent:"center",fontSize:"24px"}},l.createElement(b.s4,{icon:"ico-videocam",sx:{fontSize:40,mb:2}}),l.createElement(n.A,{ml:1},e.formatMessage({id:"connect_devices_to_go_live"}))))},x=({onReady:e,streamKey:t,sxDeviceWrapper:i,deviceDefault:r,id:o})=>{let{dispatch:s,getSetting:d,livestreamingSocket:c,dialogBackend:u,i18n:v,setNavigationConfirm:m}=(0,a.PCX)(),f=l.useRef(null),p=l.useRef(null),g=l.useRef(void 0),{per_time_recorder_webcam:b=1e3}=d("livestreaming"),y=l.useRef(null),E=c.getStatus(),[x,S]=l.useState("initialized"===E),[C,M]=l.useState(!1),[I,R]=l.useState(r),D=l.useCallback(()=>{let e=navigator.connection,t=(null==e?void 0:e.effectiveType)||"4g",i={"4g":{video:25e5,audio:128e3,framerate:30},"3g":{video:1e6,audio:64e3,framerate:24},"2g":{video:5e5,audio:32e3,framerate:15}};return i[t]||i["4g"]},[]),P=l.useCallback(e=>{var t;let i=window.performance,a=(null===(t=i.memory)||void 0===t?void 0:t.usedJSHeapSize)>5e8;return{width:{ideal:a?854:1280},height:{ideal:a?480:720},frameRate:{ideal:e.framerate}}},[]),T=l.useCallback(()=>{for(let e of["video/webm; codecs=vp9,opus","video/webm; codecs=vp8,opus","video/mp4; codecs=h264,aac"])if(MediaRecorder.isTypeSupported(e))return e;for(let t of["video/webm; codecs=vp9","video/webm; codecs=vp8","video/webm","video/mp4"])if(MediaRecorder.isTypeSupported(t))return t;return"video/webm"},[]),z=l.useCallback(async()=>{if(!t||!c)return!0;let e=await c.waitDdpMethod({name:"streaming",id:"result/streaming",params:[t]});return!e.error||(u.alert({message:e.msg?v.formatMessage({id:e.msg}):void 0}),!1)},[t,c,u,v]),W=l.useCallback(e=>{let t=D(),i=T(),a=e.getAudioTracks().length>0,r=i.includes("opus")||i.includes("aac"),n=new MediaRecorder(e,{mimeType:i,videoBitsPerSecond:t.video,audioBitsPerSecond:a&&r?t.audio:0});return g.current&&c&&(n.ondataavailable=async e=>{e.data.size>0&&c&&c.sendRaw(e.data)}),n},[D,T,c]),F=l.useCallback(()=>{if(!y.current||!p.current)return;p.current.stop();let e=W(y.current);p.current=e,e.start(b)},[W,b]);l.useEffect(()=>{let e=navigator.connection;if(e)return e.addEventListener("change",F),()=>e.removeEventListener("change",F)},[F]);let j=async()=>{y.current&&y.current.getTracks().forEach(e=>e.stop());let i=null==I?void 0:I.video,a=null==I?void 0:I.audio;try{if(t){g.current=t;let r=await z();if(!r)return}let n=D(),o=P(n),l=await navigator.mediaDevices.getUserMedia({video:{deviceId:i?{exact:i}:void 0,...o},audio:{deviceId:a?{exact:a}:void 0,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});M(!0);let s=l.getVideoTracks()[0],d=l.getAudioTracks()[0],c={video:null==s?void 0:s.getSettings().deviceId,audio:null==d?void 0:d.getSettings().deviceId};A()(c,I)||R(c),f.current&&(f.current.srcObject=l),y.current=l,e&&e(c);let u=W(l);p.current=u,u.start(b)}catch(h){console.error("Error starting stream webcam:",h);try{let v=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:15}},audio:{deviceId:a?{exact:a}:void 0,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});f.current&&(f.current.srcObject=v),y.current=v}catch(m){console.error("Fallback stream failed:",m)}}},L=(e,t)=>{R({video:e,audio:t})};return l.useEffect(()=>(s({type:"livestreaming/socket/init",meta:{onSuccess(){S(!0)}}}),t&&(m(!0,{message:v.formatMessage({id:"live_video_is_on_going_are_you_sure_to_leave_now"})},()=>{s({type:"livestreaming/end-live/force",payload:{id:o}})}),window.onbeforeunload=()=>v.formatMessage({id:"live_video_is_on_going_are_you_sure_to_leave_now"})),()=>{y.current&&y.current.getTracks().forEach(e=>e.stop()),t&&(c.close(),window.onbeforeunload=void 0,m(!1))}),[]),l.useEffect(()=>{x&&j()},[x,null==I?void 0:I.video,null==I?void 0:I.audio]),l.createElement(k,null,l.createElement(n.A,null,C?null:l.createElement(_,null),l.createElement(w,{sx:{display:C?"block":"none"}},l.createElement("video",{ref:f,autoPlay:!0,playsInline:!0,controls:!1,muted:!0})),I?l.createElement(h,{defaultValues:I,sx:i,onDeviceChange:L}):null))},S=x},71336(e,t,i){i.r(t),i.d(t,{default:()=>d});var a=i(20687),r=i(84058),n=i.n(r),o=i(96540),l=i(30261),s=i(89953);function d({config:{size:e,margin:t="normal",fullWidth:i,sxFieldWrapper:r,streamKey:d},name:c,formik:u}){let[,,{setValue:v}]=(0,l.Mt)(null!=c?c:"MuxVideoField"),m=e=>{let{video:t,audio:i}=e||{};v({video:t,audio:i})};return o.createElement(a.A,{size:e,margin:t,fullWidth:i,"data-testid":n()(`field ${c}`),sx:r},o.createElement(s.A,{onReady:m,sxDeviceWrapper:{mt:2}}))}}}]);